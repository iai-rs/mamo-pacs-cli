name: Build docker containers with ssh

on:
  push:
    branches:
      - oracle_s3

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Executing remote ssh commands
        uses: appleboy/ssh-action@v1.0.3
        env:
          VPN_USER: ${{ secrets.VPN_USER }}
          VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
          VPN_IP_ADDRESS: ${{ secrets.VPN_IP_ADDRESS }}
          VPN_PSK: ${{ secrets.VPN_PSK }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          envs: VPN_USER,VPN_PASSWORD,VPN_IP_ADDRESS,VPN_PSK
          script: |
            cd mamo-pacs-cli/ai-db-writer
            git checkout cicd
            git pull
            docker build --build-arg DB_USERNAME=postgres --build-arg DB_PASSWORD=ai-mambo --build-arg DB_HOSTNAME=ai-mambo-docker --build-arg DB_PORT=5432 --build-arg DB_NAME=postgres --build-arg MINIO_HOST=minio-server --build-arg MINIO_PORT=9000  -t ai-db-writer .
            ./ai-cron.sh vpn_user=${VPN_USER} vpn_password=${VPN_PASSWORD} vpn_ip_address=${VPN_IP_ADDRESS} vpn_psk=${VPN_PSK} &
